<% if user_signed_in? %>
<!-- Decide header based on history being viewed -->

<% if @days %>
	<% if @days.to_i == 1 %>
		<h1>Listing Purchases from the past day</h1>
	<% elsif @days.to_i == 10000 %>
		<h1>Listing Purchases </h1>
	<% else %>
		<h1>Listing Purchases from the past <%= @days %> days</h1>
	<% end %>
<% else %>
	<h1>Listing Purchases </h1>
<% end %>

<% t = Time.now %>

	 <%
	@vita = 0
	@vitb = 0
	@fiber= 0
	if @days
		@purchases.each do |purchase|
			if purchase.user == current_user.email
				if t.strftime("%d").to_i - purchase.date.strftime("%d").to_i  <= @days.to_i
					@foods.each do |food|
						if food.name == purchase.food
							@vita += food.vitamina * purchase.quantity
							@vitb += food.vitaminb * purchase.quantity
							@fiber += food.fiber * purchase.quantity
							
						end
					end
				end
			end
		end
		
	else
		@purchases.each do |purchase|
			if purchase.user == current_user.email
				@foods.each do |food|
					if food.name == purchase.food
						@vita += food.vitamina * purchase.quantity
						@vitb += food.vitaminb * purchase.quantity
						@fiber += food.fiber * purchase.quantity	
					end
				end
			end
		end
	end
	%>
		
	<!-- # Sort a 2D array by value.  Track name:string and color:string:rgb -->
	<% @amt_name_rgb = [[@vita*100/@vitadv, 'Vitamin A', 'ffffff'],[@vitb*100/@vitbdv, 'Vitamin B', '000000'],[@fiber*100/@fiberdv, 'Fiber', '0000ff']] %>
	<% @amt_name_rgb.sort! { |a,b| a <=> b } %>
	
	<!-- Check for percent DV and color code -->
	<% @amt_name_rgb.each do |food|
		if food[0] < 20
			food[2] = 'ff0000'
		elsif food[0] < 50
			food[2] = '992222'
		else
			food[2] = '00ff00'
		end
	end
	%>
	
		 <!-- Y-labels and values are taken in reverse order in this API... -->
	<%= image_tag ("http://chart.apis.google.com/chart?&chxl=1:|#{@amt_name_rgb[2][1]}|#{@amt_name_rgb[1][1]}|#{@amt_name_rgb[0][1]}&chm=N|N&chxp=1,20,50,80&chxr=0,0,105&chxs=1,000000,14&chxt=x,y&chbh=a&chs=600x400&cht=bhg&chf=bg,s,65A02C|c,s,98CC66&chco=#{@amt_name_rgb[0][2]},#{@amt_name_rgb[1][2]},#{@amt_name_rgb[2][2]}&chds=0,105,0,105&chd=t:#{@amt_name_rgb[0][0]}|#{@amt_name_rgb[1][0]}|#{@amt_name_rgb[2][0]}&chtt=Nutrient+%DV+Totals", :width => "600", :height => "400", :alt => "Horizontal bar chart") %>
	<br>
		<table>
		<tr>
			<th>Vitamin A </th>
			<th>Vitamin B </th>
			<th>Fiber</th>
		</tr>
		<tr>
		<td> <%= "#{@vita} mg"  %> </td>
		<td> <%= "#{@vitb} mg" %> </td>
		<td> <%= "#{@fiber} g" %> </td>
		</tr>
	
		<tr>
		<td> <%= "#{@vita*100/@vitadv} %"  %> </td>
		<td> <%= "#{@vitb*100/@vitbdv} %" %> </td>
		<td> <%= "#{@fiber*100/@fiberdv} %" %> </td>
		</tr>
	
	
	</table>
	<br>
	<%= link_to "Purchase Details", list_path %>
		<br>
	<%= render 'listform' %> <br>
	<%= render 'historyform' %>
<% else %>

Check out that empty graph!  You should join the site and fill it up!
<% end %>

	

	


